{
    "_comment": "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY PTERODACTYL PANEL - PTERODACTYL.IO",
    "meta": {
        "version": "PTDL_v2",
        "update_url": null
    },
    "exported_at": "2025-11-10T21:54:27-05:00",
    "name": "Dyson Sphere Program BepInEx V1.3",
    "author": "unknown@unknown.com",
    "description": "A Dyson Sphere Program multiplayer server with BepInEx mod support and R2modman\/Thunderstore profile updating.\r\nNo auto-update on server start; use reinstall to update (no files are deleted).\r\n\r\nStartup script is optimized for performance and robust download error handling.\r\n\r\nInstall script adapted by Avril112113 with community improvements.",
    "features": null,
    "docker_images": {
        "ghcr.io\/parkervcp\/yolks:wine_latest": "ghcr.io\/parkervcp\/yolks:wine_latest"
    },
    "file_denylist": [],
    "startup": "WINEDEBUG=\"-all\" WINEDLLOVERRIDES=\"mscoree=n,b;mshtml=n,b;winhttp=n,b\"; > .\/BepInEx\/LogOutput.log; tail -f .\/BepInEx\/LogOutput.log & wine DSPGAME.exe -logFile unity.log --doorstop-enable true --doorstop-target \".\\BepInEx\\core\\BepInEx.Preloader.dll\" -batchmode -nographics -nebula-server $SERVER_ARGS",
    "config": {
        "files": "{}",
        "startup": "{\r\n    \"done\": \"Game load completed\"\r\n}",
        "logs": "{}",
        "stop": "^C"
    },
    "scripts": {
        "installation": {
            "script": "#!\/bin\/bash\r\n# Improved installer: attempts a short, non-blocking SteamCMD login when username+password are provided\r\n# but no STEAM_AUTH is available. This triggers Steam Guard (email\/2FA) without hanging the container.\r\n# If Steam Guard is required the script writes instructions and exits so the admin can provide STEAM_AUTH\r\n# and re-run the installer.\r\n#\r\n# Notes:\r\n# - Uses `timeout --foreground` to run a short login attempt that will be killed if it blocks for input.\r\n# - If STEAM_AUTH is provided, performs a full non-interactive login and continues.\r\n# - If anonymous install is used (STEAM_USER empty), attempts anonymous install (may fail for paid games).\r\n#\r\nset -eo pipefail\r\n\r\n# Packages required by the script\r\napt -y update\r\napt -y --no-install-recommends --no-install-suggests install wget p7zip-full jq unzip ca-certificates coreutils\r\nwget -q --https-only https:\/\/github.com\/mikefarah\/yq\/releases\/latest\/download\/yq_linux_amd64 -O \/usr\/bin\/yq\r\nchmod +x \/usr\/bin\/yq\r\n\r\n# Helper to print and exit with a message\r\nfail() {\r\n  echo \"[ERROR] $1\" >&2\r\n  exit \"${2:-1}\"\r\n}\r\n\r\ninfo() { echo \"[INFO] $1\"; }\r\nwarn() { echo \"[WARN] $1\"; }\r\n\r\n# Default\/normalize variables (avoid 'unbound variable' failures if set -u were used elsewhere)\r\nSTEAM_USER=\"${STEAM_USER:-}\"\r\nSTEAM_PASS=\"${STEAM_PASS:-}\"\r\nSTEAM_AUTH=\"${STEAM_AUTH:-}\"\r\nWINDOWS_INSTALL=\"${WINDOWS_INSTALL:-1}\"\r\nSRCDS_APPID=\"${SRCDS_APPID:-1366540}\"\r\nSRCDS_BETAID=\"${SRCDS_BETAID:-}\"\r\nSRCDS_BETAPASS=\"${SRCDS_BETAPASS:-}\"\r\nINSTALL_FLAGS=\"${INSTALL_FLAGS:-}\"\r\nV_PROFILECODE=\"${V_PROFILECODE:-}\"\r\nBEPINEX_UPDATE_OVERWRITE=\"${BEPINEX_UPDATE_OVERWRITE:-0}\"\r\n\r\n# Setup Steam credentials logic\r\nif [[ -z \"$STEAM_USER\" ]] || [[ -z \"$STEAM_PASS\" ]]; then\r\n  info \"Steam user\/password not provided. Attempting anonymous install.\"\r\n  STEAM_USER=\"anonymous\"\r\n  STEAM_PASS=\"\"\r\n  STEAM_AUTH=\"\"\r\nelse\r\n  info \"Steam user provided: ${STEAM_USER}\"\r\nfi\r\n\r\n# Prepare steamcmd folder\r\ncd \/tmp\r\nmkdir -p \/mnt\/server\/steamcmd\r\nif ! curl -sfSL -o steamcmd.tar.gz https:\/\/steamcdn-a.akamaihd.net\/client\/installer\/steamcmd_linux.tar.gz; then\r\n  fail \"Failed to download SteamCMD.\"\r\nfi\r\ntar -xzvf steamcmd.tar.gz -C \/mnt\/server\/steamcmd\r\nmkdir -p \/mnt\/server\/steamapps\r\ncd \/mnt\/server\/steamcmd\r\nchown -R root:root \/mnt || true\r\nexport HOME=\/mnt\/server\r\n\r\n# Utility to run the final install (after successful login or anonymous allowed)\r\nrun_app_update() {\r\n  info \"Running SteamCMD app_update for AppID ${SRCDS_APPID} ...\"\r\n  # Build beta and betapassword args safely\r\n  beta_arg=\"\"\r\n  betapass_arg=\"\"\r\n  if [[ -n \"${SRCDS_BETAID}\" ]]; then\r\n    beta_arg=\"-beta ${SRCDS_BETAID}\"\r\n  fi\r\n  if [[ -n \"${SRCDS_BETAPASS}\" ]]; then\r\n    betapass_arg=\"-betapassword ${SRCDS_BETAPASS}\"\r\n  fi\r\n\r\n  # Run install; use INSTALL_FLAGS if set (splitting intentionally left to shell to handle simple flags)\r\n  if ! .\/steamcmd.sh +force_install_dir \/mnt\/server +login \"${STEAM_USER}\" \"${STEAM_PASS}\" ${STEAM_AUTH:+${STEAM_AUTH}} $( [[ \"${WINDOWS_INSTALL}\" == \"1\" ]] && printf %s '+@sSteamCmdForcePlatformType windows' ) +app_update \"${SRCDS_APPID}\" ${beta_arg} ${betapass_arg} ${INSTALL_FLAGS} validate +quit; then\r\n    fail \"SteamCMD failed to install the game.\"\r\n  fi\r\n}\r\n\r\n# LOGIN AND INSTALL DECISION LOGIC\r\nif [[ \"${STEAM_USER}\" == \"anonymous\" ]]; then\r\n  info \"Performing anonymous SteamCMD install (may fail for paid games).\"\r\n  # Try anonymous install\r\n  if ! .\/steamcmd.sh +force_install_dir \/mnt\/server +login anonymous +app_update \"${SRCDS_APPID}\" validate +quit; then\r\n    fail \"SteamCMD anonymous install failed.\"\r\n  fi\r\nelse\r\n  # User provided. Two sub-cases:\r\n  # 1) STEAM_AUTH provided => non-interactive login and proceed\r\n  # 2) STEAM_AUTH NOT provided => attempt a short login to trigger Steam Guard, but do not block\r\n  if [[ -n \"${STEAM_AUTH}\" ]]; then\r\n    info \"STEAM_AUTH provided: performing non-interactive login and install.\"\r\n    run_app_update\r\n  else\r\n    info \"Steam credentials provided but no STEAM_AUTH (2FA) code.\"\r\n    info \"Attempting a short non-blocking login attempt to trigger Steam Guard (email\/authenticator).\"\r\n    # Attempt a short login. This may block if SteamCMD prompts for input; use timeout to avoid hanging.\r\n    TMP_OUTPUT=\"\/tmp\/steamcmd_login_output.txt\"\r\n    # Use timeout --foreground to ensure child processes receive signals properly in container\r\n    LOGIN_CMD=(timeout --foreground 30s .\/steamcmd.sh +login \"${STEAM_USER}\" \"${STEAM_PASS}\" +quit)\r\n    if \"${LOGIN_CMD[@]}\" > \"$TMP_OUTPUT\" 2>&1; then\r\n      # This means login succeeded quickly (no 2FA). Proceed with install.\r\n      info \"Steam login succeeded without 2FA. Proceeding with install.\"\r\n      run_app_update\r\n    else\r\n      rc=$?\r\n      out=$(sed -n '1,200p' \"$TMP_OUTPUT\" || true)\r\n      # Check for known Steam Guard indicators in output\r\n      if [[ $rc -eq 124 ]] || echo \"$out\" | grep -Ei \"Steam Guard|SteamGuard|two-factor|2fa|authenticator|code\" >\/dev\/null; then\r\n        warn \"Steam Guard likely required (SteamCMD blocked\/waiting for 2FA).\"\r\n        cat > \/mnt\/server\/steamcmd_manual_instructions.txt <<'EOF'\r\nSteam login requires Steam Guard (2FA). The installer attempted a short login to trigger the Steam Guard flow,\r\nbut did not provide a code to avoid hanging the container.\r\n\r\nWhat you can do next:\r\n1) Provide STEAM_AUTH (the current Steam Guard code from your authenticator) as a server variable and re-run the installer (reinstall).\r\n   - This will perform a non-interactive login and continue installation automatically.\r\n\r\nOR\r\n\r\n2) Perform an interactive login manually (on a host or container where you can interact):\r\n   - cd \/mnt\/server\/steamcmd\r\n   - .\/steamcmd.sh\r\n   - At the prompt: login <your_steam_username>\r\n   - Enter your password and Steam Guard code when prompted.\r\n   - Then run:\r\n       force_install_dir \/mnt\/server\r\n       app_update 1366540 validate\r\n       quit\r\n\r\nNotes:\r\n- If Steam sends the code via email, check that account's email.\r\n- Avoid leaving the installer to wait for input in a non-interactive environment (it will hang the container).\r\nEOF\r\n        info \"Instructions written to \/mnt\/server\/steamcmd_manual_instructions.txt\"\r\n        warn \"Re-run the installer with STEAM_AUTH provided (preferred) or perform interactive login as described.\"\r\n        rm -f \"$TMP_OUTPUT\"\r\n        exit 2\r\n      else\r\n        # Some other error occurred (bad credentials, network, etc.)\r\n        echo \"$out\"\r\n        rm -f \"$TMP_OUTPUT\"\r\n        fail \"SteamCMD login failed for an unexpected reason (check output above).\"\r\n      fi\r\n    fi\r\n  fi\r\nfi\r\n\r\n# If we reach here, install succeeded and we continue with remaining steps.\r\n\r\n# Setup Steam libraries (best-effort)\r\nmkdir -p \/mnt\/server\/.steam\/sdk32\r\ncp -v linux32\/steamclient.so ..\/.steam\/sdk32\/steamclient.so || true\r\nmkdir -p \/mnt\/server\/.steam\/sdk64\r\ncp -v linux64\/steamclient.so ..\/.steam\/sdk64\/steamclient.so || true\r\n\r\n# Install & Setup Goldberg Steam Emu\r\ninfo \"Downloading Goldberg steam_api64.dll ...\"\r\nif ! curl -sfSL -o \"$HOME\/DSPGAME_Data\/Plugins\/x86_64\/steam_api64.dll\" \"https:\/\/gitlab.com\/Mr_Goldberg\/goldberg_emulator\/-\/jobs\/4247811310\/artifacts\/raw\/steam_api64.dll\"; then\r\n  fail \"Failed to download Goldberg steam_api64.dll.\"\r\nfi\r\nmkdir -p \/mnt\/server\/DSPGAME_Data\/Plugins\/x86_64\/steam_settings\r\ntouch \/mnt\/server\/DSPGAME_Data\/Plugins\/x86_64\/steam_settings\/disable_networking.txt\r\necho \"1366540\" > \/mnt\/server\/DSPGAME_Data\/Plugins\/x86_64\/steam_appid.txt\r\n\r\n# Download and install BepInEx\r\ncd \/mnt\/server\r\ninfo \"Downloading BepInEx release info ...\"\r\nif ! api_response=$(curl -sfSL -H \"accept: application\/json\" \"https:\/\/thunderstore.io\/api\/experimental\/package\/xiaoye97\/BepInEx\/\"); then\r\n    fail \"Could not retrieve BepInEx release info from Thunderstore.io API\"\r\nfi\r\ndownload_url=$(echo \"$api_response\" | jq -r \".latest.download_url\")\r\nversion_number=$(echo \"$api_response\" | jq -r \".latest.version_number\")\r\nif ! wget --https-only --content-disposition \"$download_url\"; then\r\n  fail \"Failed to download BepInEx package.\"\r\nfi\r\nif ! unzip -qo xiaoye97-BepInEx-${version_number}.zip; then\r\n  fail \"Failed to unzip BepInEx package.\"\r\nfi\r\ncp -r \/mnt\/server\/BepInExPack\/* \/mnt\/server || true\r\n\r\n# Modpack\/Profile Installation (unchanged logic, but robust quoting)\r\nif [ ! -z \"$V_PROFILECODE\" ]; then\r\n  function fix_filenames {\r\n    local BAD_FILES\r\n    BAD_FILES=$(find \"$1\" -regex '.*\\\\.*' 2>\/dev\/null || true)\r\n    while IFS= read -r SRC; do\r\n      if [[ $SRC ]]; then\r\n        local DST\r\n        DST=$(echo \"$SRC\" | sed 's\/\\\\\/\\\/\/g')\r\n        mkdir -p \"$(dirname \"$DST\")\"\r\n        mv \"$SRC\" \"$DST\"\r\n      fi\r\n    done <<< \"$BAD_FILES\"\r\n  }\r\n\r\n  function thunderstore_get_profile {\r\n    local PROFILE_CODE=$1\r\n    local OUT_DIR=$2\r\n    if [[ -d \"$OUT_DIR\" ]]; then\r\n      rm -r \"$OUT_DIR\"\r\n    fi\r\n    info \"Downloading profile $PROFILE_CODE\"\r\n    if ! wget -qO mods.base64 --https-only \"https:\/\/thunderstore.io\/api\/experimental\/legacyprofile\/get\/$PROFILE_CODE\/\"; then\r\n      fail \"Failed to download Thunderstore profile.\"\r\n    fi\r\n    tail -n +2 mods.base64 | base64 --decode > mods.zip\r\n    rm mods.base64\r\n\r\n    info \"Extracting profile archive\"\r\n    if ! 7z x -y mods.zip -o\"$OUT_DIR\" > \/dev\/null; then\r\n      fail \"Failed to extract Thunderstore profile archive with 7z.\"\r\n    fi\r\n\r\n    rm mods.zip\r\n  }\r\n\r\n  function thunderstore_download {\r\n    local OUT_DIR=$1\r\n    local PACKAGE=$2\r\n    local VERSION=$3\r\n    local PACKAGE_ALT\r\n    PACKAGE_ALT=$(echo \"$PACKAGE\" | sed -r 's\/\\\/\/-\/g')\r\n    info \"Downloading mod $PACKAGE @ $VERSION ($PACKAGE_ALT)\"\r\n    if ! wget -qO tmp.zip --https-only \"https:\/\/thunderstore.io\/package\/download\/$PACKAGE\/$VERSION\/\"; then\r\n      fail \"Failed to download mod $PACKAGE.\"\r\n    fi\r\n    mkdir tmp\r\n    7z x tmp.zip -o\"tmp\" -y > \/dev\/null\r\n    rm tmp.zip\r\n    fix_filenames .\/tmp\r\n    if [[ $(find .\/tmp\/* -maxdepth 0 -type d 2>\/dev\/null | wc -l) == 1 ]]; then\r\n      local DIR\r\n      DIR=$(find .\/tmp\/* -maxdepth 0 -type d)\r\n      while [[ $(find \"$DIR\"\/* -maxdepth 0 2>\/dev\/null | wc -l) == 1 ]]; do\r\n        DIR=$(find .\/tmp\/* -maxdepth 0 -type d)\r\n        mv \"$DIR\"\/* \"$(dirname \"$DIR\")\"\r\n        rm -r \"$DIR\"\r\n      done\r\n    fi\r\n    mkdir -p \"$OUT_DIR\/$PACKAGE_ALT\"\r\n    mv .\/tmp\/* \"$OUT_DIR\/$PACKAGE_ALT\"\r\n    rm -r .\/tmp\r\n  }\r\n\r\n  function get_profile_mods {\r\n    local YAML_PATH=$1\r\n    yq '[.mods[] | select(.enabled == true) | ((.name | sub(\"-\", \"\/\")) + \" \" + .version.major + \".\" + .version.minor + \".\" + .version.patch)][]' \"$YAML_PATH\"\r\n  }\r\n\r\n  function update_from_profile_code {\r\n    local PROFILE_CODE=$1\r\n    local BEPINEX_DIR=$2\r\n    thunderstore_get_profile \"$PROFILE_CODE\" .\/tmp_mods\r\n    while IFS= read -r args; do\r\n      if [[ $args != *\"BepInExPack_\"* ]]; then\r\n        thunderstore_download .\/tmp_mods\/BepInEx\/plugins\/ $args\r\n      fi\r\n    done <<< \"$(get_profile_mods .\/tmp_mods\/export.r2x)\"\r\n    info \"Preparing mod files\"\r\n    fix_filenames .\/tmp_mods\r\n    cp -rf .\/tmp_mods\/BepInEx\/* .\/tmp_mods || true\r\n    rm -r .\/tmp_mods\/BepInEx || true\r\n    rm -rf \"$BEPINEX_DIR\/plugins\/\"*\r\n    mkdir -p \"$BEPINEX_DIR\"\r\n    if [[ \"${BEPINEX_UPDATE_OVERWRITE:-0}\" == \"1\" ]]; then\r\n      info \"Overwriting all mod files.\"\r\n      cp -rf .\/tmp_mods\/* \"$BEPINEX_DIR\"\r\n    else\r\n      info \"Updating mods (not overwriting configs, ensure no changes are required)\"\r\n      cp -rfn .\/tmp_mods\/* \"$BEPINEX_DIR\"\r\n    fi\r\n    rm -r .\/tmp_mods\r\n    info \"Mods updated.\"\r\n  }\r\n\r\n  update_from_profile_code \"$V_PROFILECODE\" \/mnt\/server\/BepInEx\r\nfi\r\n\r\n# Clean-up\r\nrm -rf BepInExPack icon.png xiaoye97-BepInEx-* manifest.json README.m || true\r\n\r\ninfo \"-----------------------------------------\"\r\ninfo \"Installation completed.\"\r\ninfo \"-----------------------------------------\"",
            "container": "ghcr.io\/parkervcp\/installers:debian",
            "entrypoint": "bash"
        }
    },
    "variables": [
        {
            "name": "App id",
            "description": "Steam app ID for Dyson Sphere Program.",
            "env_variable": "SRCDS_APPID",
            "default_value": "1366540",
            "user_viewable": false,
            "user_editable": false,
            "rules": "required|string",
            "field_type": "text"
        },
        {
            "name": "Auto Update",
            "description": "If enabled, the server will attempt to update automatically on boot.",
            "env_variable": "AUTO_UPDATE",
            "default_value": "0",
            "user_viewable": false,
            "user_editable": false,
            "rules": "required|boolean",
            "field_type": "text"
        },
        {
            "name": "Windows",
            "description": "Set to 1 for Windows server installation.",
            "env_variable": "WINDOWS_INSTALL",
            "default_value": "1",
            "user_viewable": false,
            "user_editable": false,
            "rules": "required|boolean",
            "field_type": "text"
        },
        {
            "name": "WINEPATH",
            "description": "Path for Wine user directory (default: \/home\/container).",
            "env_variable": "WINEPATH",
            "default_value": "\/home\/container",
            "user_viewable": false,
            "user_editable": false,
            "rules": "required|string",
            "field_type": "text"
        },
        {
            "name": "WINEDEBUG",
            "description": "Wine debug output level (default: -all for performance).",
            "env_variable": "WINEDEBUG",
            "default_value": "-all",
            "user_viewable": false,
            "user_editable": false,
            "rules": "required|string",
            "field_type": "text"
        },
        {
            "name": "Profile Code",
            "description": "Enter the profile code exported from R2modman or Thunderstore to automatically download mods.\nAll mods and configs will be replaced by the selected profile on reinstall. Use different profile codes for different setups. Mod updates\/changes require a server reinstall to apply.",
            "env_variable": "V_PROFILECODE",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "string|nullable",
            "field_type": "text"
        },
        {
            "name": "STEAM_USER",
            "description": "Steam username.",
            "env_variable": "STEAM_USER",
            "default_value": "",
            "user_viewable": false,
            "user_editable": false,
            "rules": "required|string",
            "field_type": "text"
        },
        {
            "name": "STEAM_PASS",
            "description": "Steam password.",
            "env_variable": "STEAM_PASS",
            "default_value": "",
            "user_viewable": false,
            "user_editable": false,
            "rules": "required|string",
            "field_type": "text"
        },
        {
            "name": "STEAM_AUTH",
            "description": "Steam 2FA token.",
            "env_variable": "STEAM_AUTH",
            "default_value": "",
            "user_viewable": false,
            "user_editable": false,
            "rules": "nullable|string",
            "field_type": "text"
        },
        {
            "name": "WINETRICKS_RUN",
            "description": "Extra Wine dependencies to install, separated by spaces.",
            "env_variable": "WINETRICKS_RUN",
            "default_value": "vcrun2013 vcrun2017 corefonts dotnet48",
            "user_viewable": false,
            "user_editable": false,
            "rules": "nullable|string",
            "field_type": "text"
        },
        {
            "name": "SERVER_ARGS",
            "description": "Arguments for DSP server process. Example: `-newgame-cfg` for a new game, `-load-latest` to load last exit save.",
            "env_variable": "SERVER_ARGS",
            "default_value": "-newgame-cfg",
            "user_viewable": true,
            "user_editable": true,
            "rules": "string",
            "field_type": "text"
        },
        {
            "name": "Steam Beta Branch",
            "description": "Specify a Steam beta branch (e.g., previous-version).",
            "env_variable": "SRCDS_BETAID",
            "default_value": "",
            "user_viewable": true,
            "user_editable": true,
            "rules": "nullable|string",
            "field_type": "text"
        },
        {
            "name": "Overwrite mods",
            "description": "If enabled, ALL mod files including configs will be overwritten when profile is applied.",
            "env_variable": "BEPINEX_UPDATE_OVERWRITE",
            "default_value": "0",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|boolean",
            "field_type": "text"
        },
        {
            "name": "VALIDATE",
            "description": "If enabled, game files will be validated on installation.",
            "env_variable": "VALIDATE",
            "default_value": "1",
            "user_viewable": true,
            "user_editable": true,
            "rules": "required|boolean",
            "field_type": "text"
        }
    ]
}
